name: ROS2 CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup ROS2 Humble
      uses: ros-tooling/setup-ros2@v0.7
      with:
        required-ros-distributions: humble
        # 或者使用 specific-ros-distributions: humble 如果你只需要特定版本
    
    - name: Install dependencies with rosdep
      shell: bash
      run: |
        source /opt/ros/humble/setup.bash
        export ROS_DISTRO=humble
        export ROS_PYTHON_VERSION=3
        sudo apt-get update
        rosdep update --rosdistro humble
        rosdep install --from-paths src --ignore-src -y --skip-keys="libopencv-dev libopencv-contrib-dev libopencv-imgproc-dev python-opencv python3-opencv tf serial"
    
    - name: Build workspace
      run: |
        source /opt/ros/humble/setup.bash
        colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release
    
    - name: Test workspace
      run: |
        source /opt/ros/humble/setup.bash
        source install/setup.bash
        colcon test --return-code-on-test-failure
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          log/**/test_results
          log/**/test_run